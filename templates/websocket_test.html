<!DOCTYPE html>
<html>
  <head>
    <title>WebSocket Test</title>
    <style>
      #messages {
        height: 300px;
        border: 1px solid #ccc;
        overflow-y: auto;
        margin-bottom: 10px;
        padding: 10px;
      }
      #item-name {
        cursor: pointer;
        background-color: bisque;
        margin: 4px;
        padding: 4px;
        width: fit-content;
      }
      .message {
        margin: 5px 0;
        padding: 5px;
        background: #f0f0f0;
      }
      .item {
        margin: 5px 0;
        padding: 5px;
        font-size: 20px;
        background: #d07d09;
        width: fit-content;
        padding: 2px;
      }
      .remove-button {
        background-color: red;
        padding: 2px;
      }
    </style>
  </head>
  <body>
    <h2>WebSocket Test</h2>
    <div>Table Code: <span id="tableCode"></span></div>
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Type a message..." />
    <button onclick="sendMessage()">Send</button>
    <script>
      const dishes = [
        { dish_name: "Jollof rice", price: 1500 },
        { dish_name: "Fried rice", price: 1800 },
        { dish_name: "Goat meat", price: 2500 },
        { dish_name: "Asun", price: 2000 },
      ];

      // Generate divs for each dish
      dishes.forEach((dish) => {
        const div = document.createElement("div");

        div.textContent = `${dish.dish_name} - ₦${dish.price}`;
        div.onclick = (e) => addItem(e, dish);
        div.style.cursor = "pointer";
        div.style.backgroundColor = "bisque";
        div.style.margin = "4px";
        div.style.padding = "4px";
        div.style.width = "fit-content";

        document.body.appendChild(div);
      });
    </script>

    <div>
      <h3>
        Connected Users:
        <button
          onclick="fetchConnectedUsers()"
          style="margin-left: 10px; padding: 2px 8px"
        >
          Refresh
        </button>
      </h3>
      <ul id="userList"></ul>
      <div style="display: flex; gap: 20px" id="user-menu-{{.userID}}"></div>
    </div>

    <script>
      // Declare usernames at a higher scope so it is accessible outside functions
      let usernames = [];
      let items = [];

      // Get table code from URL or generate a new one
      const urlParams = new URLSearchParams(window.location.search);
      let tableCode = urlParams.get("code");
      const ws = new WebSocket(
        `ws://${window.location.host}/ws/table/${tableCode}`
      );

      async function initializeTable() {
        if (!tableCode) {
          // If no tableCode in URL, create a new table
          try {
            const response = await fetch("/api/create-table", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            });
            const data = await response.json();
            if (response.ok) {
              tableCode = data.code; // Use the code returned by the API
              window.history.replaceState({}, "", `?code=${tableCode}`);
              console.log("New table created with code:", tableCode);
            } else {
              console.error("Failed to create table:", data.error);
              alert("Failed to create table: " + data.error);
              return;
            }
          } catch (error) {
            console.error("Error creating table:", error);
            alert("Error creating table. Please check console.");
            return;
          }
        }

        document.getElementById("tableCode").textContent = tableCode;

        ws.onopen = async function () {
          addMessage("Connected to WebSocket");
          // Fetch users after connection is established
          await fetchConnectedUsers();
        };

        ws.onmessage = async function (event) {
          const msg = JSON.parse(event.data);

          if (msg.type === "menu_add") {
            // Add item to the correct user's menu
            const userListMenu = document.getElementById(
              `menu-list-${msg.username}`
            );
            if (userListMenu) {
              const item = document.createElement("li");
              item.textContent = msg.item;
              userListMenu.appendChild(item);
            }
            return; // Don't treat as chat
          }

          // Default: treat as chat message
          addMessage(`${msg.SenderID}: ${msg.Content}`);

          // Check if this is a join/leave message and update user list
          if (
            msg.Content &&
            (msg.Content.includes("joined") ||
              msg.Content.includes("left") ||
              msg.Content.includes("disconnected"))
          ) {
            console.log("User list change detected, fetching updated list...");
            await fetchConnectedUsers();
          }
        };

        ws.onclose = function () {
          addMessage("Disconnected from WebSocket");
        };

        ws.onerror = function (error) {
          console.error("WebSocket error:", error);
          addMessage(`Error: ${error.message || "Connection failed"}`);
        };
      }

      async function updateUserList(newUsernames) {
        usernames = newUsernames;
        const userList = document.getElementById("userList");
        userList.innerHTML = "";

        // Clear and rebuild the userMenu
        const userMenu = document.getElementById("user-menu-{{.userID}}");
        userMenu.innerHTML = "";

        if (usernames.length === 0) {
          const li = document.createElement("li");
          li.textContent = "No users connected";
          userList.appendChild(li);
        } else {
          usernames.forEach((username) => {
            // Add to userList
            const li = document.createElement("li");
            li.textContent = username;
            userList.appendChild(li);

            // Create a column for each user in the menu
            const userCol = document.createElement("div");
            userCol.className = "user-menu-column";
            userCol.style.display = "flex";
            userCol.style.flexDirection = "column";
            userCol.style.alignItems = "center";
            userCol.style.minWidth = "120px";

            const userHeader = document.createElement("h1");
            userHeader.textContent = username;
            userHeader.style.fontSize = "1.2em";
            userHeader.style.marginBottom = "8px";
            userCol.appendChild(userHeader);

            const userListMenu = document.createElement("ul");
            userListMenu.id = `menu-list-${username}`;
            userListMenu.style.listStyle = "none";
            userListMenu.style.padding = "0";

            userCol.appendChild(userListMenu);

            userMenu.appendChild(userCol);
          });
        }
      }

      initializeTable(); // Call the initialization function

      ws.onopen = async function () {
        addMessage("Connected to WebSocket");
        // Fetch users after connection is established
        await fetchConnectedUsers();
      };

      ws.onmessage = async function (event) {
        const msg = JSON.parse(event.data);

        if (msg.type === "menu_add") {
          // Menu items are now created directly in addItem function
          // This handler can be used for other users' menu updates if needed
          return; // Don't treat as chat
        }

        if (msg.type === "menu_remove") {
          // Remove item from the correct user's menu
          const userListMenu = document.getElementById(
            `menu-list-${msg.username}`
          );
          if (userListMenu) {
            // Find and remove the first item that matches the text
            const items = userListMenu.querySelectorAll("li");
            const itemBaseName = msg.item.split(" - ")[0]; // Get item name without price

            for (let item of items) {
              const itemText = item.textContent.replace("Remove", "").trim();
              if (itemText === itemBaseName) {
                item.remove();
                break; // Remove only the first matching item
              }
            }
          }
          return; // Don't treat as chat
        }

        // Default: treat as chat message
        addMessage(`${msg.SenderID}: ${msg.Content}`);

        // Check if this is a join/leave message and update user list
        if (
          msg.Content &&
          (msg.Content.includes("joined") ||
            msg.Content.includes("left") ||
            msg.Content.includes("disconnected"))
        ) {
          console.log("User list change detected, fetching updated list...");
          await fetchConnectedUsers();
        }
      };

      ws.onclose = function () {
        addMessage("Disconnected from WebSocket");
      };

      ws.onerror = function (error) {
        console.error("WebSocket error:", error);
        addMessage(`Error: ${error.message || "Connection failed"}`);
      };

      // Function to fetch and display connected users
      async function fetchConnectedUsers() {
        try {
          const response = await fetch(`/api/tables/${tableCode}`);
          const data = await response.json();

          if (response.ok && data.usernames) {
            await updateUserList(data.usernames);
            await fetchAllItemsInTable();
          }
        } catch (error) {
          console.error("Error fetching users:", error);
        }
      }

      async function fetchAllItemsInTable() {
        try {
          const response = await fetch(`/api/tables/${tableCode}/table-items`);
          const data = await response.json();

          console.log("Data:", data);

          // Populate the items array and append to user menus
          data.forEach((item) => {
            items.push(item);
            // Use the added_by_username from the API response to find the correct menu
            const userListMenu = document.getElementById(
              `menu-list-${item.added_by_username}`
            );
            if (userListMenu) {
              const menuItem = document.createElement("li");
              const itemRemoveButton = document.createElement("button");

              menuItem.className = "item";
              menuItem.textContent = item.name + " - $" + item.price;
              itemRemoveButton.textContent = "Remove";
              itemRemoveButton.style.marginLeft = "10px";
              itemRemoveButton.onclick = function (event) {
                event.stopPropagation();
                removeItemFromMenu(event, item);
              };

              menuItem.appendChild(itemRemoveButton);
              userListMenu.appendChild(menuItem);
            }
          });
        } catch (error) {
          console.error("Error fetching items for table:", error);
        }
      }

      async function addItemToDB(event, dish) {
        try {
          const response = await fetch(`/api/tables/add-item-to-order`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              name: dish.dish_name,
              price: dish.price,
              table_code: tableCode,
            }),
          });
          console.log("Response:", response);
          console.log(tableCode, dish.dish_name, dish.price);

          if (!response.ok) {
            throw new Error("Failed to add item");
          }

          const result = await response.json();
          console.log("Item added:", result);

          // Also update the menu via WebSocket
          const currentUsername = "{{ .username }}";
          const messageObj = {
            type: "menu_add",
            username: currentUsername,
            item: `${dish.dish_name} - ₦${dish.price}`,
          };
          ws.send(JSON.stringify(messageObj));

          return result; // Return the database item with ID
        } catch (error) {
          console.error("Error adding item:", error);
          return null; // Return null on error
        }
      }

      async function removeItemFromDB(event, dish) {
        try {
          const response = await fetch(`/api/items/${dish.id}`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
          });

          console.log("Item removed");

          if (!response.ok) {
            throw new Error();
            ("Failed to Remove item");
          }

          const currentUsername = "{{ .username }}";
          const messageObj = {
            type: "menu_add",
            username: currentUsername,
            item: `${dish.dish_name} - ₦${dish.price}`,
          };
        } catch (error) {
          console.error("Error removing item:", error);
        }
      }

      function addMessage(text) {
        const messages = document.getElementById("messages");
        const message = document.createElement("div");
        message.className = "message";
        message.textContent = text;
        messages.appendChild(message);
        messages.scrollTop = messages.scrollHeight;
      }

      async function addItem(event, dish) {
        if (!dish) {
          console.warn(
            "addItem called without a dish object. This might be due to an old event listener."
          );
          return;
        }
        // Get the clicked element
        const clickedDiv = event.target;
        // Extract the text content
        const itemText = clickedDiv.textContent;

        // First add to database to get the item with ID
        const dbItem = await addItemToDB(event, dish);
        if (!dbItem) {
          console.error("Failed to add item to database");
          return;
        }

        const currentUsername = "{{ .username }}";
        const userListMenu = document.getElementById(
          `menu-list-${currentUsername}`
        );

        if (userListMenu) {
          // Create a new item element for each addition
          const tableItem = document.createElement("li");
          const itemRemoveButton = document.createElement("button");
          tableItem.className = "item";
          tableItem.textContent = itemText;
          itemRemoveButton.textContent = "Remove";
          itemRemoveButton.style.marginLeft = "10px";
          itemRemoveButton.onclick = function (event) {
            event.stopPropagation();
            removeItemFromMenu(event, dbItem);
          };

          tableItem.appendChild(itemRemoveButton);
          userListMenu.appendChild(tableItem);
        }

        // Add message to message container
        addMessage(`You added an item to your menu: ${itemText}`);

        // Also send via WebSocket if needed
        const messageObj = {
          content: `Added item: ${itemText}`,
        };
        ws.send(JSON.stringify(messageObj));
      }

      function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value;
        if (message) {
          // Create a message object with type and content
          const messageObj = {
            type: "chat",
            content: message,
          };
          ws.send(JSON.stringify(messageObj));
          addMessage(`{{ .username }}: ${messageObj.content}`);
          input.value = "";
        }
      }

      async function removeItemFromMenu(event, dish) {
        event.preventDefault();
        event.stopPropagation();

        const itemId = dish.id;

        try {
          const response = await fetch(`/api/items/${itemId}`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            // Remove the UI element
            event.target.parentElement.remove();

            const currentUsername = "{{ .username }}";
            const messageObj = {
              type: "menu_remove",
              username: currentUsername,
              item: `${dish.dish_name} - ₦${dish.price}`,
            };

            ws.send(JSON.stringify(messageObj));
            addMessage(`You removed an item from your menu: ${dish.dish_name}`);
            fetchConnectedUsers();
          } else {
            console.error("Failed to remove item from database");
          }
        } catch (error) {
          console.error("Error removing item:", error);
        }
      }

      // Allow sending message with Enter key
      document
        .getElementById("messageInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            sendMessage();
          }
        });
    </script>
  </body>
</html>
